name: Android Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # æ ¸å¿ƒæ­¥éª¤ï¼šè·å–æœ€æ–°ç‰ˆæœ¬å·å¹¶+1
      - name: Get latest versionName and increment
        id: get_version
        run: |
          # 1. è°ƒç”¨APIè·å–æœ€æ–°Releaseçš„tag_nameï¼ˆå¸¦è®¤è¯é¿å…é¢‘ç‡é™åˆ¶ï¼‰
          LATEST_VERSION=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/zzlb0224/Tick/releases/latest | jq -r '.tag_name')
          
          # 2. å»æ‰ç‰ˆæœ¬å‰ç¼€ï¼ˆå¦‚v1.2.3 â†’ 1.2.3ï¼Œæ— våˆ™è·³è¿‡ï¼‰
          LATEST_VERSION=${LATEST_VERSION#v}
          
          # 3. ç‰ˆæœ¬å·æœ€åä¸€ä½+1ï¼ˆå…¼å®¹xã€x.yã€x.y.zç­‰æ ¼å¼ï¼‰
          # æ‹†åˆ†ç‰ˆæœ¬å·ä¸ºæ•°ç»„
          IFS='.' read -ra VERSION_PARTS <<< "$LATEST_VERSION"
          # è·å–æœ€åä¸€ä½å¹¶+1
          LAST_PART=${VERSION_PARTS[-1]}
          NEW_LAST_PART=$((LAST_PART + 1))
          # é‡ç»„ç‰ˆæœ¬å·
          unset VERSION_PARTS[-1]
          NEW_VERSION="${VERSION_PARTS[*]}.${NEW_LAST_PART}"
          # å»é™¤å¤šä½™ç©ºæ ¼ï¼ˆæ•°ç»„è½¬å­—ç¬¦ä¸²æ—¶çš„åˆ†éš”ç¬¦é—®é¢˜ï¼‰
          NEW_VERSION=${NEW_VERSION// /}
          
          # 4. è¾“å‡ºå˜é‡ä¾›åç»­ä½¿ç”¨
          echo "ORIGINAL_VERSION=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Original version: $LATEST_VERSION â†’ New version: $NEW_VERSION"

      # åŸæœ‰JDKé…ç½®ï¼ˆæœªä¿®æ”¹ï¼‰
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: gradle

      # åŸæœ‰Gradleæƒé™ï¼ˆæœªä¿®æ”¹ï¼‰
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ç¼–è¯‘APKï¼ˆæ–°å¢ç‰ˆæœ¬å·æ—¥å¿—ï¼‰
      - name: Build Release APK
        run: |
          echo "ğŸ“¤ Building APK for new version: ${{ steps.get_version.outputs.NEW_VERSION }}"
          ./gradlew assembleRelease --no-daemon --stacktrace

      # äº§ç‰©å‘½åï¼ˆä½¿ç”¨+1åçš„ç‰ˆæœ¬å·ï¼‰
      - name: Rename & Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ steps.get_version.outputs.NEW_VERSION }}.apk
          path: app/build/outputs/apk/release/*.apk
