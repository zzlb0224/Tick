name: Android Build & Sign & Release

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆæäº¤ä»£ç çš„æƒé™

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´æäº¤å†å²
          persist-credentials: true  # ä¿ç•™å‡­è¯ç”¨äºæ¨é€

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: gradle

      # å®‰è£…ä¾èµ–
      - name: Install Android SDK Build Tools
        run: |
          sudo apt update -y
          sudo apt install -y android-sdk-build-tools zip unzip

      # è‡ªåŠ¨é€’å¢å¹¶æ°¸ä¹…ä¿®æ”¹versionName/versionCode
      - name: Auto bump version (persist to build.gradle)
        run: |
          set -e
          BUILD_GRADLE="app/build.gradle"

          # è¯»å–å½“å‰ç‰ˆæœ¬å·ï¼ˆå…œåº•é»˜è®¤å€¼ï¼‰
          if grep -qE '^[[:space:]]*versionName' "$BUILD_GRADLE"; then
            CURRENT_VERSION_NAME=$(grep -m1 -E '^[[:space:]]*versionName' "$BUILD_GRADLE" | sed -E 's/.*versionName[[:space:]]*"([^"]+)".*/\1/')
          else
            CURRENT_VERSION_NAME="1.0.0"
          fi

          if grep -qE '^[[:space:]]*versionCode' "$BUILD_GRADLE"; then
            CURRENT_VERSION_CODE=$(grep -m1 -E '^[[:space:]]*versionCode' "$BUILD_GRADLE" | sed -E 's/.*versionCode[[:space:]]*([0-9]+).*/\1/')
          else
            CURRENT_VERSION_CODE=1
          fi

          # è®¡ç®—æ–°ç‰ˆæœ¬å·
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION_NAME"
          MAJOR=${PARTS[0]:-0}
          MINOR=${PARTS[1]:-0}
          PATCH=${PARTS[2]:-0}
          PATCH=$((PATCH + 1))
          NEW_VERSION_NAME="${MAJOR}.${MINOR}.${PATCH}"

          echo "ğŸ”§ ç‰ˆæœ¬å·å˜æ›´ï¼š${CURRENT_VERSION_NAME}(${CURRENT_VERSION_CODE}) â†’ ${NEW_VERSION_NAME}(${NEW_VERSION_CODE})"

          # ç²¾å‡†ä¿®æ”¹build.gradle
          sed -i.bak -E "s/^([[:space:]]*)versionCode[[:space:]]*[0-9]+/\1versionCode ${NEW_VERSION_CODE}/" "$BUILD_GRADLE"
          sed -i.bak -E "s/^([[:space:]]*)versionName[[:space:]]*\"[^\"]+\"/\1versionName \"${NEW_VERSION_NAME}\"/" "$BUILD_GRADLE"
          rm -f "${BUILD_GRADLE}.bak"

          # å…œåº•æ’å…¥ç‰ˆæœ¬å·ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          if ! grep -qE '^[[:space:]]*versionName' "$BUILD_GRADLE"; then
            sed -i "/^[[:space:]]*defaultConfig {/a \        versionName \"${NEW_VERSION_NAME}\"" "$BUILD_GRADLE"
          fi
          if ! grep -qE '^[[:space:]]*versionCode' "$BUILD_GRADLE"; then
            sed -i "/^[[:space:]]*defaultConfig {/a \        versionCode ${NEW_VERSION_CODE}" "$BUILD_GRADLE"
          fi

          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "NEW_VERSION_NAME=${NEW_VERSION_NAME}" >> $GITHUB_ENV
          echo "NEW_VERSION_CODE=${NEW_VERSION_CODE}" >> $GITHUB_ENV

          # æäº¤ä¿®æ”¹åˆ°ä»£ç åº“
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          if git diff --quiet "$BUILD_GRADLE"; then
            echo "â„¹ï¸ ç‰ˆæœ¬å·æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git add "$BUILD_GRADLE"
            git commit -m "chore: bump version to v${NEW_VERSION_NAME} (build ${NEW_VERSION_CODE})"
            git push origin "${{ github.ref }}"
            echo "âœ… ç‰ˆæœ¬å·å·²æäº¤åˆ°ä»£ç åº“"
          fi

      # è§£å¯†keystoreï¼ˆä¿®å¤æ ¸å¿ƒè¯­æ³•é”™è¯¯ï¼‰
      - name: Decrypt keystore
        # æ­£ç¡®å†™æ³•ï¼šç”¨${{ }}åŒ…è£¹ï¼Œä¸”åŒæ—¶åˆ¤æ–­ä¸¤ä¸ªsecretsæ˜¯å¦å­˜åœ¨
        if: ${{ secrets.GPG_PASSWORD && secrets.KEYSTORE_FILE }}
        run: |
          gpg --quiet --batch --yes --decrypt --passphrase="${{ secrets.GPG_PASSWORD }}" \
          --output my-release-key.keystore ${{ secrets.KEYSTORE_FILE }}
          if [ ! -f "my-release-key.keystore" ]; then
            echo "âŒ keystoreè§£å¯†å¤±è´¥" && exit 1
          fi

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean & Build Release APK
        run: |
          ./gradlew clean assembleRelease --no-daemon
          if [ ! -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼šæœªæ‰¾åˆ°unsigned APK" && exit 1
          fi

      - name: Sign APK
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore my-release-key.keystore \
          -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
          -keypass ${{ secrets.KEY_PASSWORD }} \
          $APK_PATH ${{ secrets.KEY_ALIAS }}
          /usr/bin/zipalign -v 4 $APK_PATH "app/build/outputs/apk/release/app-v${{ env.NEW_VERSION_NAME }}-release-signed.apk"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION_NAME }}
          name: Release v${{ env.NEW_VERSION_NAME }} (build ${{ env.NEW_VERSION_CODE }})
          body: |
            ## è‡ªåŠ¨å‘å¸ƒçš„ç•ªèŒ„é’ŸAPP
            - ç‰ˆæœ¬å·ï¼šv${{ env.NEW_VERSION_NAME }}
            - æ„å»ºå·ï¼š${{ env.NEW_VERSION_CODE }}
          files: app/build/outputs/apk/release/app-v${{ env.NEW_VERSION_NAME }}-release-signed.apk
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up
        if: always()
        run: rm -f my-release-key.keystore
