name: Android Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # æ–°å¢æ­¥éª¤ï¼šè·å–æœ€æ–°Releaseçš„versionNameï¼ˆä»…æå–tag_nameï¼Œä¸ä¿®æ”¹ä»»ä½•æ–‡ä»¶ï¼‰
      - name: Get latest release versionName
        id: get_latest_version
        run: |
          # è°ƒç”¨GitHub APIè·å–æœ€æ–°Releaseï¼Œæå–tag_nameï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
          # è‡ªåŠ¨å¤„ç†APIé¢‘ç‡é™åˆ¶ï¼šä½¿ç”¨å†…ç½®GITHUB_TOKENè®¤è¯
          LATEST_VERSION=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/zzlb0224/Tick/releases/latest | jq -r '.tag_name')
          # å¯é€‰ï¼šå»æ‰ç‰ˆæœ¬æ ‡ç­¾å‰ç¼€ï¼ˆå¦‚v1.0.0 â†’ 1.0.0ï¼‰ï¼Œä¸éœ€è¦åˆ™æ³¨é‡Šæ­¤è¡Œ
          LATEST_VERSION=${LATEST_VERSION#v}
          # å°†ç‰ˆæœ¬å·è¾“å‡ºä¸ºstepå˜é‡ï¼Œä¾›åç»­æ­¥éª¤å¤ç”¨ï¼ˆå¦‚äº§ç‰©å‘½åã€æ—¥å¿—è¾“å‡ºï¼‰
          echo "VERSION_NAME=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Latest versionName fetched: $LATEST_VERSION"

      # åŸæœ‰é€»è¾‘ï¼šJDK 8é…ç½®ï¼ˆæœªä¿®æ”¹ï¼‰
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: gradle

      # åŸæœ‰é€»è¾‘ï¼šGradleæƒé™ï¼ˆæœªä¿®æ”¹ï¼‰
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # åŸæœ‰é€»è¾‘ï¼šç¼–è¯‘Release APKï¼ˆæœªä¿®æ”¹ï¼Œå¯æŒ‰éœ€æ·»åŠ ç‰ˆæœ¬å·æ—¥å¿—ï¼‰
      - name: Build Release APK
        run: |
          echo "ğŸ“¤ Building APK for version: ${{ steps.get_latest_version.outputs.VERSION_NAME }}"
          ./gradlew assembleRelease --no-daemon --stacktrace

      # ä¼˜åŒ–ï¼šäº§ç‰©å‘½åï¼ˆå«versionNameï¼‰ï¼Œä¿æŒåŸæœ‰ä¸Šä¼ é€»è¾‘
      - name: Rename & Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ steps.get_latest_version.outputs.VERSION_NAME }}.apk
          path: app/build/outputs/apk/release/*.apk
