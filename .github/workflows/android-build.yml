name: Android Build & Sign & Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整提交历史

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: gradle

      # 安装zipalign依赖
      - name: Install Android SDK Build Tools
        run: |
          sudo apt update
          sudo apt install -y android-sdk-build-tools

      # 自动递增版本号（带默认值兜底）
      - name: Auto increment version code and name
        run: |
          BUILD_GRADLE_PATH="app/build.gradle"
          CURRENT_VERSION_NAME=$(grep -oP 'versionName "\K[^"]+' $BUILD_GRADLE_PATH || echo "1.0.0")
          CURRENT_VERSION_CODE=$(grep -oP 'versionCode \K\d+' $BUILD_GRADLE_PATH || echo "1")
          
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
          NEW_VERSION_NAME=$(echo $CURRENT_VERSION_NAME | awk -F. '{print $1"."$2"."$3+1}')
          
          echo "Current version: $CURRENT_VERSION_NAME (code: $CURRENT_VERSION_CODE)"
          echo "New version: $NEW_VERSION_NAME (code: $NEW_VERSION_CODE)"
          
          # 新增/替换versionCode
          if ! grep -q "versionCode" $BUILD_GRADLE_PATH; then
            sed -i '/defaultConfig {/a \        versionCode '"$NEW_VERSION_CODE" $BUILD_GRADLE_PATH
          else
            sed -i "s/versionCode $CURRENT_VERSION_CODE/versionCode $NEW_VERSION_CODE/" $BUILD_GRADLE_PATH
          fi
          
          # 新增/替换versionName
          if ! grep -q "versionName" $BUILD_GRADLE_PATH; then
            sed -i '/defaultConfig {/a \        versionName "'"$NEW_VERSION_NAME"'"' $BUILD_GRADLE_PATH
          else
            sed -i "s/versionName \"$CURRENT_VERSION_NAME\"/versionName \"$NEW_VERSION_NAME\"/" $BUILD_GRADLE_PATH
          fi
          
          echo "NEW_VERSION_NAME=$NEW_VERSION_NAME" >> $GITHUB_ENV
          echo "NEW_VERSION_CODE=$NEW_VERSION_CODE" >> $GITHUB_ENV

      # 解密keystore（若未加密则跳过）
      - name: Decrypt keystore
        run: |
          gpg --quiet --batch --yes --decrypt --passphrase="${{ secrets.GPG_PASSWORD }}" \
          --output my-release-key.keystore ${{ secrets.KEYSTORE_FILE }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Sign APK
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "app-release-unsigned.apk")
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore my-release-key.keystore \
          -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
          -keypass ${{ secrets.KEY_PASSWORD }} \
          $APK_PATH ${{ secrets.KEY_ALIAS }}
          # 带版本号命名APK
          /usr/bin/zipalign -v 4 $APK_PATH app/build/outputs/apk/release/app-v${{ env.NEW_VERSION_NAME }}-release-signed.apk

      # 自动发布到GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION_NAME }}
          name: Release v${{ env.NEW_VERSION_NAME }} (build ${{ env.NEW_VERSION_CODE }})
          body: |
            ## 自动发布的番茄钟APP
            - 版本号：v${{ env.NEW_VERSION_NAME }}
            - 构建号：${{ env.NEW_VERSION_CODE }}
            - 发布时间：${{ github.event.head_commit.timestamp }}
          files: app/build/outputs/apk/release/app-v${{ env.NEW_VERSION_NAME }}-release-signed.apk
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up keystore
        if: always()
        run: rm -f my-release-key.keystore
