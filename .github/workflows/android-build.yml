name: Android Build & Sign & Release

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整提交历史

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: gradle

      # 安装zipalign依赖
      - name: Install Android SDK Build Tools
        run: |
          sudo apt update
          sudo apt install -y android-sdk-build-tools

      # 自动递增版本号（带默认值兜底）
      - name: Auto increment version code and name
        run: |
          set -euo pipefail
          BUILD_GRADLE_PATH="app/build.gradle"

          # read current values (fallback to defaults)
          if grep -q 'versionName' "$BUILD_GRADLE_PATH"; then
            CURRENT_VERSION_NAME=$(grep -m1 'versionName' "$BUILD_GRADLE_PATH" | sed -E 's/.*versionName *"([^"]+)".*/\1/')
          else
            CURRENT_VERSION_NAME="1.0.0"
          fi

          if grep -q 'versionCode' "$BUILD_GRADLE_PATH"; then
            CURRENT_VERSION_CODE=$(grep -m1 'versionCode' "$BUILD_GRADLE_PATH" | sed -E 's/.*versionCode *([0-9]+).*/\1/')
          else
            CURRENT_VERSION_CODE=1
          fi

          # compute new values
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))

          IFS='.' read -r MAJOR MINOR PATCH <<< "${CURRENT_VERSION_NAME}"
          MAJOR=${MAJOR:-0}; MINOR=${MINOR:-0}; PATCH=${PATCH:-0}
          if ! [[ $PATCH =~ ^[0-9]+$ ]]; then PATCH=0; fi
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION_NAME="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "Current version: ${CURRENT_VERSION_NAME} (code: ${CURRENT_VERSION_CODE})"
          echo "New version: ${NEW_VERSION_NAME} (code: ${NEW_VERSION_CODE})"

          # replace or insert versionCode
          if grep -q 'versionCode' "$BUILD_GRADLE_PATH"; then
            sed -i -E "s/(versionCode[[:space:]]*)[0-9]+/\1${NEW_VERSION_CODE}/" "$BUILD_GRADLE_PATH"
          else
            sed -i "/defaultConfig {/a \        versionCode ${NEW_VERSION_CODE}" "$BUILD_GRADLE_PATH"
          fi

          # replace or insert versionName
          if grep -q 'versionName' "$BUILD_GRADLE_PATH"; then
            sed -i -E "s/(versionName[[:space:]]*")[^"]+("[[:space:]]*)/\1${NEW_VERSION_NAME}\2/" "$BUILD_GRADLE_PATH"
          else
            sed -i "/defaultConfig {/a \        versionName \"${NEW_VERSION_NAME}\"" "$BUILD_GRADLE_PATH"
          fi

          echo "NEW_VERSION_NAME=${NEW_VERSION_NAME}" >> $GITHUB_ENV
          echo "NEW_VERSION_CODE=${NEW_VERSION_CODE}" >> $GITHUB_ENV

      # 解密keystore（若未加密则跳过）
      - name: Decrypt keystore
        run: |
          gpg --quiet --batch --yes --decrypt --passphrase="${{ secrets.GPG_PASSWORD }}" \
          --output my-release-key.keystore ${{ secrets.KEYSTORE_FILE }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Sign APK
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "app-release-unsigned.apk")
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore my-release-key.keystore \
          -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
          -keypass ${{ secrets.KEY_PASSWORD }} \
          $APK_PATH ${{ secrets.KEY_ALIAS }}
          # 带版本号命名APK
          /usr/bin/zipalign -v 4 $APK_PATH app/build/outputs/apk/release/app-v${{ env.NEW_VERSION_NAME }}-release-signed.apk

      # 自动发布到GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION_NAME }}
          name: Release v${{ env.NEW_VERSION_NAME }} (build ${{ env.NEW_VERSION_CODE }})
          body: |
            ## 自动发布的番茄钟APP
            - 版本号：v${{ env.NEW_VERSION_NAME }}
            - 构建号：${{ env.NEW_VERSION_CODE }}
            - 发布时间：${{ github.event.head_commit.timestamp }}
          files: app/build/outputs/apk/release/app-v${{ env.NEW_VERSION_NAME }}-release-signed.apk
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up keystore
        if: always()
        run: rm -f my-release-key.keystore
